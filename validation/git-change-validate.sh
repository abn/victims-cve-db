#!/usr/bin/env bash

UPSTREAMDB=upstreamdb

function error()
{
    echo >&2 "[ERROR] $1"
}

function info()
{
    echo "[INFO] $1"
}

function validate_name()
{
    NAME="$1"
    echo $NAME | grep -E "^database/.*/[0-9]{4}/[0-9]{4,}\.yaml"
}

git remote show | grep "${UPSTREAMDB}" >/dev/null
if [ $? -ne 0 ]; then
    info "Adding upstream remote repository"
    git remote add ${UPSTREAMDB} https://github.com/victims/victims-cve-db.git
fi

info "Fetching upstream master"
git fetch ${UPSTREAMDB}

COMPARE_TO="${UPSTREAMDB}/master"
if [ "$(git rev-parse HEAD)" == "$(git rev-parse ${COMPARE_TO})" ]; then
    info "Comparing to HEAD^"
    COMPARE_TO="HEAD^"
fi

STATUS=0
git diff --name-only ${COMPARE_TO} | grep "^database/.*\.yaml" | \
    while read line; do
        info "Validating $line"

        validate_name $line
        if [ $? -ne 0 ]; then
            error "Invalid file name $line"
            STATUS=1
        fi

        LANG=$(echo $line | cut -d'/' -f 2)
        python validation/validate_yaml.py ${LANG} "$line"
        if [ $? -ne 0 ]; then
            error "Validation failed for $line"
            STATUS=1
        fi
    done

exit $STATUS
