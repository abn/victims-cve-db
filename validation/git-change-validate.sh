#!/usr/bin/env bash

UPSTREAMDB=upstreamdb

function log()
{
    MSG=$1
    echo "[validation] ${MSG}"
}

function validate_name()
{
    NAME="$1"
    echo $NAME | grep "/[0-9]*\.yaml"
}

git remote show | grep "${UPSTREAMDB}"
if [ $? -ne 0 ]; then
    git remote add ${UPSTREAMDB} https://github.com/victims/victims-cve-db.git
fi
git fetch ${UPSTREAMDB}

STATUS=0
git diff --name-only ${UPSTREAMDB}/master | grep "^database/\.yaml" | \
    while read line; do
        log "Validating $line"

        validate_name $line
        if [ $? -ne 0 ]; then
            log "Invalid file name $line"
        fi

        LANG=$(echo $line | cut -d'/' -f 2)
        python validation/validate_yaml.py ${LANG} "$line"
        if [ $? -ne 0 ]; then
            log "Validation failed for $line"
            STATUS=1
        fi
    done

exit $STATUS
